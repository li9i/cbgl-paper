%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% No mention of r-fields here. r-fields are part of the solution
\subsection{Motivation}

The proposed method's motivation lies in the simple but powerful fact that, in
general, is exhibited through figure \ref{fig:face}: Assume a pose estimate
residing in a neighbourhood of a 2D LIDAR sensor's pose within a given map;
then the CAER metric between the scan measured by the sensor and the map-scan
captured from the estimate within the map---the CAER metric is simultaneously
proportional to both the estimate's location error and orientation error.
Formally the proposed method's foundations rest on Observation
\ref{obs:observation_o}:

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{customobs}{O}
  \label{obs:observation_o} It may be observed that there are conditions such
  that Hypothesis \ref{hpt:hypothesis_h} stands true.
\end{customobs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{customhpt}{H}
  \label{hpt:hypothesis_h}
  There exists $\hat{\bm{p}} \in  \mathbb{R}^2 \times [-\pi,+\pi)$ such that
  $\hat{\bm{p}} \in \mathcal{V}: \|\bm{p}-\hat{\bm{p}}\|_2 \leq \delta \leq \delta_0$
  is an admissible pose estimate solution to Problem \ref{prob:the_problem}
  (def. \ref{def:definition_7}), where set $\mathcal{V}$ and $\delta_0$ are
  defined by Conjecture
  \ref{cnj:conjecture_c}.
\end{customhpt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{customcnj}{C}
  \label{cnj:conjecture_c}
  Let the unknown pose of a 2D range sensor measuring range scan $\mathcal{S}_R$
  (def. \ref{def:definition_1}) be $\bm{p}(x,y,\theta)$ with respect to the
  reference frame of map $\bm{M}$.
  Let $\mathcal{H}$ be a set of pose hypotheses within the free (i.e.
  traversable) space of $\bm{M}$:
  $\mathcal{H} = \{\hat{\bm{p}}_i(\hat{x}_i,\hat{y}_i,\hat{\theta}_i)\} \subseteq \texttt{free}(\bm{M})$,
  $i \in \texttt{I} = \langle 0,1,\dots,|\mathcal{H}|-1\rangle$.
  Let $f_{\psi}^{\bm{M}}$ be the $\psi$-field on $\bm{M}$
  (def. \ref{def:definition_4}) such that $f_{\psi}^{\bm{M}}(\mathcal{H})= \Psi$.
  Let the field's locational and orientational densities be
  $d_{l}$ and $d_{\alpha}$.
  Let $\hat{\bm{p}}_\omega \in \mathcal{H}$ and $\psi_0,\delta_0 \in \mathbb{R}_{>0}$
  such that $f_{\psi}^{\bm{M}}(\hat{\bm{p}}_\omega ) = \psi_0$ and
  $\|\bm{p}-\hat{\bm{p}}_j\|_2 \leq \delta_0$ for all
  $\hat{\bm{p}}_j \in \mathcal{H}: f_{\psi}^{\bm{M}}(\hat{\bm{p}}_j) \leq \psi_0$.
  Let now $\mathcal{V} = \{\hat{\bm{p}}_i \in \mathcal{H}: f_{\psi}^{\bm{M}}(\hat{\bm{p}}_i) \leq \psi_0,
  \|\bm{p}-\hat{\bm{p}}_i\|_2 \leq \delta_0\}$.
  Without loss of generality there exist $d_{l}, d_{\alpha}$, and
  $\psi_0,\delta_0$ such that for all
  $\hat{\bm{p}}_\mathcal{V} \in \mathcal{V}$:
  \begin{align}
    f_{\psi}^{\bm{M}}(\hat{\bm{p}}_\mathcal{V}) &< f_{\psi}^{\bm{M}}(\hat{\bm{p}}) \ \ \ \Leftrightarrow \nonumber \\
    \|\bm{p}-\hat{\bm{p}}_\mathcal{V}\|_2 &< \|\bm{p}-\hat{\bm{p}}_{}\|_2 \nonumber
  \end{align}
  for any $\hat{\bm{p}}_{} \in \mathcal{X} = \mathcal{H} \setminus  \mathcal{V}: \|\bm{p}-\hat{\bm{p}}_{}\|_2 > \delta_0$.
\end{customcnj}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{remark}
  \label{rem:remark_1}
  The composition of
  $\mathcal{H} = \mathcal{V} \cup \mathcal{X} \cup \mathcal{W}$, where
  $\mathcal{W} = \hat{\bm{p}} \in {\mathcal{H} \setminus \mathcal{V}}: \|\bm{p}-\hat{\bm{p}}\|_2 \leq \delta_0$.
\end{remark}

In simple terms Conjecture \ref{cnj:conjecture_c} states that, in general,
given a dense enough set of pose hypotheses $\mathcal{H}$ over a map $\bm{M}$,
it is possible to partition $\mathcal{H}$ into (non-empty) sets $\mathcal{V}$,
$\mathcal{X}$, and $\mathcal{W}$ such that the error of pose estimates in set
$\mathcal{V}$ and their corresponding CAER values are simultaneously lower than
those of estimates in set $\mathcal{X}$. Hypothesis \ref{hpt:hypothesis_h}
restrictingly states that $\mathcal{V}$ is populated by a pose estimate
whose error is such that it is deemed an admissible solution to
Problem \ref{prob:the_problem}.

\begin{figure}
  \input{./figures/h_fig.tex}
  \vspace{0.7cm}
  \caption{\small The $\psi$-field (left) and \texttt{r}-field (right) of a
           configuration where Observation \ref{obs:observation_o} can be made
           for $\delta \leq \delta_0$}
  \label{fig:h_fig1}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The CBGL System}

In the same vein as Hypothesis \ref{hpt:hypothesis_h} assume the \texttt{r}-field
$f_{\texttt{r}}^{\bm{M}}(\mathcal{H})$ corresponding to the $\psi$-field
$f_{\psi}^{\bm{M}}(\mathcal{H})$ on a given map $\bm{M}$ (def.
\ref{def:definition_5}) such that $\Psi[\texttt{I}^{\ast}] = \Psi_\uparrow$,
and $f_{\texttt{r}}^{\bm{M}}(\mathcal{H}[\texttt{I}^{\ast}]) = \texttt{I}$.
The top $k \ll |\mathcal{H}|$ ranked pose hypotheses
$\mathcal{H}[\texttt{I}^{\ast}]_{0:k-1}$ define set $\mathcal{V}$ such that
$\psi_0 = \max f_{\psi}^{\bm{M}}(\mathcal{H}[\texttt{I}^{\ast}]_{0:k-1})$,
and for all $\hat{\bm{p}}_\mathcal{V} \in \mathcal{V}$
and any $\hat{\bm{p}}_{\mathcal{X}} \in \mathcal{X}$:
$ f_{\texttt{r}}^{\bm{M}}(\hat{\bm{p}}_\mathcal{V}) < f_{\texttt{r}}^{\bm{M}}(\hat{\bm{p}}_{\mathcal{X}}) \Leftrightarrow
f_{\psi}^{\bm{M}}(\hat{\bm{p}}_\mathcal{V}) < f_{\psi}^{\bm{M}}(\hat{\bm{p}}_\mathcal{X}) \Leftrightarrow
\|\bm{p}-\hat{\bm{p}}_\mathcal{V}\|_2 < \|\bm{p}-\hat{\bm{p}}_{\mathcal{X}}\|_2$.
Deprived of external limiting factors, the challenge here is constructing set
field $f_{\texttt{r}}^{\bm{M}}(\mathcal{H})$ with densities $d_{\bm{l}}$ and
$d_\alpha$ such that Observation \ref{obs:observation_o} may be performed.

% TALK ABOUT SET W HERE






\begin{figure}[]\centering
  \input{./figures/cbgl_system.tikz}
  \caption{\small CBGL in block diagram form. Given a LIDAR's 2D measurement
           $\mathcal{S}_R$ and the map $\bm{M}$ that represents the environment
           in which the sensor is posed, CBGL generates a set of pose hypotheses
           $\mathcal{H}$ and invokes the estimation of the $k$ hypotheses with
           the least pose error (fig. \ref{fig:bottom_k}; alg.
           \ref{alg:bottom_k}). Then it scan-to-map-scan matches those to the
           measurement for finer estimation and outlier rejection (alg.
           \ref{alg:sm2}). CBGL's output pose estimate is that with the least
           CAER among matched estimates}
  \label{fig:cbgl}
\end{figure}

\begin{figure}[]\centering
  \input{./figures/inner_ranking_system2.tikz}
  \caption{\small CBGL's core method. Given a LIDAR's 2D measurement
           $\mathcal{S}_R$, the map $\bm{M}$ that represents the environment in
           which the sensor is posed, and a set of pose hypotheses
           $\mathcal{H}$, CBGL (a) computes and ranks the CAER values between
           the measurement and map-scans captured from the hypotheses within
           the map, and (b) outputs the hypotheses with the $k$ lowest CAER
           values}
  \label{fig:bottom_k}
\end{figure}





%% CBGL %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\floatstyle{spaceruled}
\restylefloat{algorithm}
\begin{algorithm}
  \caption{\texttt{CBGL}}
  \begin{spacing}{1.2}
  \begin{algorithmic}[1]
    \REQUIRE $\mathcal{S}_R$, $\bm{M}$, $|\mathcal{H}|$, $k$
    \ENSURE $\hat{\bm{p}}$
    \STATE $\mathcal{H} \leftarrow \{\varnothing\}$
    \FOR {$i \leftarrow 0,1,\dots,|\mathcal{H}|-1$}
      \STATE $\hat{\bm{p}}_i \leftarrow \texttt{rand}(\hat{x},\hat{y},\hat{\theta}): (x,y) \in \texttt{free}(\bm{M})$
      \STATE $\mathcal{H} \leftarrow \{\mathcal{H}, \hat{\bm{p}}_i\}$
    \ENDFOR
    \STATE $\mathcal{H}_1 \leftarrow$ \texttt{bottom}$\_k\_\texttt{poses}(\mathcal{S}_R, \bm{M}, \mathcal{H}, k)$ \hfill {\small (Alg. \ref{alg:bottom_k}})
    \STATE $\mathcal{H}_2 \leftarrow \{\varnothing \}$
    \FOR {$k \leftarrow 0,1,\dots,|\mathcal{H}_1|-1$}
      \STATE $\hat{\bm{h}}^\prime \leftarrow \texttt{sm2}(\mathcal{S}_R, \bm{M}, \mathcal{H}_1[k])$ \hfill {\small (Alg. \ref{alg:sm2} or e.g. \texttt{x1} \cite{Filotheou2023a}})
      \STATE $\mathcal{H}_2 \leftarrow \{\mathcal{H}_2, \hat{\bm{h}}^\prime\}$
    \ENDFOR
    \STATE $\hat{\bm{p}} \leftarrow$ \texttt{bottom}$\_k\_\texttt{poses}(\mathcal{S}_R, \bm{M}, \mathcal{H}_2, 1)$
    \RETURN $\hat{\bm{p}}$
  \end{algorithmic}
  \end{spacing}
  \label{alg:cbgl}
\end{algorithm}

%% Bottom-n %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\floatstyle{spaceruled}
\restylefloat{algorithm}
\begin{algorithm}
  \caption{\texttt{bottom}\_$k$\_\texttt{poses}}
  \begin{spacing}{1.2}
  \begin{algorithmic}[1]
    \REQUIRE $\mathcal{S}_R$, $\bm{M}$, $\mathcal{H}$, $k$
    \ENSURE $\mathcal{H}_{\triangledown}$
    \STATE $\Psi \leftarrow \{\varnothing \}$
    \FOR {$h \leftarrow 0,1,\dots,|\mathcal{H}|-1$}
      \STATE $\mathcal{S}_V^{\hspace{1pt} h} \leftarrow \texttt{scan\_map}(\bm{M}, \mathcal{H}[h])$
      \STATE $\psi \leftarrow 0$
      \FOR {$n \leftarrow 0,1,\dots,|\mathcal{S}_R|-1$}
        \STATE $\psi \leftarrow \psi + \big|\mathcal{S}_R[n]-\mathcal{S}_V^{\hspace{1pt} h}[n]\big|$ \hfill {\small (Eq. (\ref{eq:caer})})
      \ENDFOR
      \STATE $\Psi \leftarrow \{\Psi, \psi\}$
    \ENDFOR
    \STATE $[\Psi_{\uparrow}, \texttt{I}^{\ast}] \leftarrow \texttt{sort}(\Psi, \texttt{asc})$
    \STATE $\mathcal{H}_{\triangledown} \leftarrow \{\varnothing \}$
    \FOR {$h \leftarrow 0,1,\dots,k-1$}
      \STATE $\mathcal{H}_{\triangledown} \leftarrow \{\mathcal{H}_{\triangledown}, \mathcal{H}[\texttt{I}^{\ast}[h]]\}$
    \ENDFOR
    \RETURN $\mathcal{H}_{\triangledown}$
  \end{algorithmic}
  \end{spacing}
  \label{alg:bottom_k}
\end{algorithm}

%% sm2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\floatstyle{spaceruled}
\restylefloat{algorithm}
\begin{algorithm}
  \caption{\texttt{sm2}}
  \begin{spacing}{1.2}
  \begin{algorithmic}[1]
    \REQUIRE $\mathcal{S}_R$, $\bm{M}$, $\hat{\bm{p}}$
    \ENSURE $\hat{\bm{p}}^\prime$
    \STATE $\mathcal{S}_V \leftarrow \texttt{scan\_map}(\bm{M}, \hat{\bm{p}})$
    \STATE $\bm{\Delta p} \leftarrow \texttt{scan-match}(\mathcal{S}_R,\mathcal{S}_V)$ \hfill {\small (e.g. \texttt{ICP}\cite{Vizzo2023}, \texttt{FSM}\cite{Filotheou2022f}})
    \STATE $\hat{\bm{p}}^\prime \leftarrow \hat{\bm{p}} + \bm{\Delta p}$
    \RETURN $\hat{\bm{p}}^\prime$
  \end{algorithmic}
  \end{spacing}
  \label{alg:sm2}
\end{algorithm}



%\lipsum[0-2]
